import{z as it,j,r as k,g as p,o as f,b as r,a as ct,k as B,i as q,q as H,F as x,s as A,t as c,n as ut,d as dt,x as I,w as pt,f as N,B as ft,C as W,S as gt,y as R}from"./app-DAFVx_ll.js";import{_ as mt}from"./Modal-BK_-FZ-K.js";const ht={class:"bg-white p-4 rounded-2xl w-full max-w-96 sm:max-w-[40rem] lg:max-w-full mx-auto"},vt={class:"flex gap-4 justify-between mx-auto"},yt={class:"overflow-y-auto lg:py-60 lg:h-screen lg:pt-0 lg:pb-0 scrollbar-hide"},bt={class:"w-full mt-2 border"},_t={class:"border p-2 text-center"},St={class:"border p-2 text-center"},xt={class:"border p-2 text-center"},Ct={class:"border p-2 text-center"},wt={class:"border p-2 text-center"},Tt={class:"border p-2 text-center"},Ft={class:"border p-2 text-center"},Mt={class:"border p-2 text-center"},Dt={class:"border p-1 text-center"},Pt={class:"mt-4 flex justify-center"},jt=["onClick","innerHTML"],kt=["innerHTML"],Bt={class:"p-8 bg-gradient-to-br from-white via-gray-50 to-gray-200 rounded-2xl shadow-2xl mx-auto"},At=["value"],Nt={key:0,class:"mb-4"},Gt={class:"flex justify-end gap-3 mt-8"},$t={__name:"ListSales",props:{sales:Object,cashFloat:Object,shifts:Object,roomServiceConfig:Object},setup(z){const n=z,_=it().props.auth.user;console.log("User Permissions:",_.permissions),console.log("Room Service Config:",n.roomServiceConfig);const T=Number(n.cashFloat&&n.cashFloat.amount?n.cashFloat.amount:0),Q=j(()=>_&&_.permissions&&_.permissions.includes("generate cutoff")),l=k(""),a=k(""),y=k(!1),X=()=>{y.value=!0},F=()=>{y.value=!1},G=o=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(o),Y=(o,t)=>`${o} x ${G(t)}`,J=(o,t)=>G(o*t),M=o=>{const t=n.shifts.find(e=>e.name_shift===o);return t?`${t.start_time} - ${t.end_time}`:""};console.log("Schedule for Matutino:",M("Matutino")),console.log("Schedule for Vespertino:",M("Vespertino"));function S(o=a.value,t=l.value){var m;if(!o||!t)return[];console.log("Filtering sales for shift:",o,"and date:",t);const e=M(o);if(!e)return console.warn("No schedule for shift:",o),[];const[s="",i=""]=e.split("-").map(u=>u.trim());console.log("Shift schedule:",s,i);const h=u=>{const d=(u||"0:00").split(":").map(Number);return{hours:Number.isFinite(d[0])?d[0]:0,minutes:Number.isFinite(d[1])?d[1]:0}};console.log("Parsed start time:",h(s)),console.log("Parsed end time:",h(i));const g=h(s),v=h(i),b=Array.isArray((m=n.sales)==null?void 0:m.data)?n.sales.data:[];return console.log("Total sales to filter:",b.length),b.filter(u=>{const d=new Date(u.date_time);if(isNaN(d))return!1;const U=d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");if(U!==t)return!1;console.log("Sale date matches selected date:",U);const w=d.getHours(),L=d.getMinutes(),D=w>g.hours||w===g.hours&&L>=g.minutes;console.log("isAfterStart:",D);const P=w<v.hours||w===v.hours&&L<=v.minutes;return console.log("isBeforeEnd:",P),console.log("Sales includes:",u.id,"->",D&&P),D&&P})}function K(o){return!o||!o.length?null:new Date(Math.min(...o.map(t=>new Date(t.date_time))))}const Z=j(()=>n.roomServiceConfig&&n.roomServiceConfig.length>0&&n.roomServiceConfig[0].is_active),tt=j(()=>Z.value&&n.roomServiceConfig.length>0&&n.roomServiceConfig[0].service_cost||0);function C(o){const t=(o||[]).filter(s=>!s.is_courtesy).reduce((s,i)=>s+i.quantity*i.unit_price,0),e=(o||[]).filter(s=>!s.is_courtesy&&s.is_room).reduce((s,i)=>s+i.quantity*i.unit_price*(tt.value/100),0);return{baseTotal:t,serviceTotal:e,totalWithService:t+e}}function V(o){const t=new Set;let e=0;return o.forEach(s=>{s.order&&!t.has(s.order.id)&&s.order.tip!==null&&s.order.tip!==void 0&&s.order.tip!==""&&(e+=parseFloat(s.order.tip),t.add(s.order.id))}),e}function O(o){return o.reduce((t,e)=>{const s=e.order&&e.order.tip_percent?parseFloat(e.order.tip_percent):0;return t+e.quantity*e.unit_price*(s/100)},0)}function $(o){const t=new Date(o);return t.getFullYear()+"-"+String(t.getMonth()+1).padStart(2,"0")+"-"+String(t.getDate()).padStart(2,"0")+" "+String(t.getHours()).padStart(2,"0")+":"+String(t.getMinutes()).padStart(2,"0")+":"+String(t.getSeconds()).padStart(2,"0")}async function E(){const o=l.value;if(!o||!a.value)return alert("Por favor, selecciona una fecha y un turno."),null;const t=S(a.value,o);if(!t||!t.length)return null;const e=K(t),s=C(t),i=s.baseTotal,h=s.serviceTotal,g=s.totalWithService,v=V(t),b=O(t);return{user_id:_.id,start_date:$(e),end_date:$(e),shift:a.value,initial_amount:T,total_amount:i,total_service:h,total_with_service:g,final_amount:T+g,total_tips:v+b}}function et(o=a.value,t=l.value){let e=S(o,t);return e=e.filter(s=>s.payment_method==="Efectivo"&&!s.is_courtesy),e}function ot(o=a.value,t=l.value){let e=S(o,t);return e=e.filter(s=>s.payment_method==="Tarjeta"&&!s.is_courtesy),e}function rt(o=a.value,t=l.value){let e=S(o,t);return e=e.filter(s=>s.is_courtesy===1),e}async function st(){const o=await E();try{const t=await W.post("/CashAudit",o);R().success("Corte de caja Generado Exitosamente"),F(),alert(`Corte de caja generado y guardado exitosamente.
Propinas: $${o.total_tips.toFixed(2)}`)}catch{F(),R().error("Error al generar el corte de caja")}}const at=async()=>{if(!await E()){alert("No hay ventas para la fecha y turno seleccionados.");return}F(),gt.fire({title:"¿Estás seguro?",text:"¡No podrás revertir esto!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sí, generar corte",cancelButtonText:"Cancelar"}).then(t=>{t.isConfirmed&&st()})},nt=()=>{const o=l.value,t=S(a.value,o);if(!t.length){alert("No hay ventas para la fecha y turno seleccionados.");return}const e=C(t),s=C(et(a.value,o)),i=C(ot(a.value,o)),g=(rt(a.value,o)||[]).reduce((m,u)=>m+u.quantity*u.unit_price,0),v=e.totalWithService,b={fecha:l.value,turno:a.value,totalVentas:e.baseTotal,totalRoomService:e.serviceTotal,montoFinal:T+v,totalPropinas:V(t)+O(t),totalEfectivo:s.totalWithService,totalTarjeta:i.totalWithService,totalCortesias:g};W.get(route("print.cutOff"),{params:{data:b}}).then(m=>{if(m.data&&m.data.printData){const u="print://"+m.data.printData;window.location.href=u}})};function lt(){console.log("Selected date:",l.value),I.get(route("Sales/Index"),{date:l.value},{preserveState:!0,replace:!0})}return(o,t)=>(f(),p(x,null,[r("div",ht,[r("div",vt,[B(r("input",{"onUpdate:modelValue":t[0]||(t[0]=e=>l.value=e),onChange:lt,type:"date",placeholder:"Buscar Ventas por fecha",class:"border p-2 rounded-lg w-full"},null,544),[[H,l.value]]),Q.value?(f(),p("button",{key:0,onClick:X,class:"bg-approveGreen hover:bg-green-700 text-white px-4 py-2 lg:w-96 rounded-md uppercase"}," Generar Corte de Caja ")):q("",!0)]),r("div",yt,[r("table",bt,[t[6]||(t[6]=r("thead",null,[r("tr",{class:"bg-gray-100"},[r("th",{class:"p-4"},"#"),r("th",{class:"p-4"},"Fecha de Creación"),r("th",{class:"p-4"},"Orden ID"),r("th",{class:"p-4"},"Usuario"),r("th",{class:"p-4"},"Producto"),r("th",{class:"p-4"},"Subtotal"),r("th",{class:"p-4"},"Total"),r("th",{class:"p-4"},"Método de Pago"),r("th",{class:"p-1"},"Room Service")])],-1)),r("tbody",null,[(f(!0),p(x,null,A(n.sales.data,e=>(f(),p("tr",{key:e.id},[r("td",_t,c(e.id),1),r("td",St,c(e.date_time),1),r("td",xt,c(e.order_id),1),r("td",Ct,c(e.user.name),1),r("td",wt,c(e.product?e.product.name:e.product_id),1),r("td",Tt,c(Y(e.quantity,e.unit_price)),1),r("td",Ft,c(J(e.quantity,e.unit_price)),1),r("td",Mt,c(e.payment_method),1),r("td",Dt,c(e.is_room?"Sí":"No"),1)]))),128))])])]),r("div",Pt,[(f(!0),p(x,null,A(n.sales.links,e=>(f(),p(x,{key:e.label},[e.url?(f(),p("button",{key:0,onClick:s=>dt(I).get(e.url,{},{preserveState:!0,replace:!0}),class:ut(["px-3 py-1 mx-1 rounded",{"bg-approveGreen text-white":e.active}]),innerHTML:e.label},null,10,jt)):(f(),p("span",{key:1,class:"px-3 py-1 mx-1 text-gray-400",innerHTML:e.label},null,8,kt))],64))),128))])]),ct(mt,{show:y.value,"onUpdate:show":t[4]||(t[4]=e=>y.value=e),onClose:t[5]||(t[5]=e=>y.value=!1)},{default:pt(()=>[r("div",Bt,[t[9]||(t[9]=r("h3",{class:"text-2xl font-extrabold text-gray-800 mb-2 flex items-center gap-2"},[r("svg",{class:"w-7 h-7 text-approveGreen",fill:"none",stroke:"currentColor","stroke-width":"2",viewBox:"0 0 24 24"},[r("path",{d:"M12 8v4l3 3"}),r("circle",{cx:"12",cy:"12",r:"10"})]),N(" Generar Corte ")],-1)),t[10]||(t[10]=r("p",{class:"mb-6 text-gray-600 text-base"},[N(" ¿Cuál será el "),r("span",{class:"font-semibold text-approveGreen"},"Turno"),N(" para este corte de caja? ")],-1)),B(r("select",{"onUpdate:modelValue":t[1]||(t[1]=e=>a.value=e),class:"border border-gray-300 rounded-lg p-3 w-full focus:ring-2 focus:ring-approveGreen focus:outline-none transition mb-4"},[t[7]||(t[7]=r("option",{value:"",disabled:""},"Seleccione un turno",-1)),(f(!0),p(x,null,A(n.shifts,e=>(f(),p("option",{key:e.id,value:e.name_shift},c(e.name_shift)+" "+c(e.start_time.slice(0,5))+" - "+c(e.end_time.slice(0,5)),9,At))),128))],512),[[ft,a.value]]),a.value==="Matutino"||a.value==="Vespertino"?(f(),p("div",Nt,[t[8]||(t[8]=r("label",{class:"block text-gray-700 font-medium mb-2"},"Fecha Seleccionada",-1)),B(r("input",{"onUpdate:modelValue":t[2]||(t[2]=e=>l.value=e),type:"date",class:"border border-gray-300 rounded-lg p-3 w-full focus:ring-2 focus:ring-approveGreen focus:outline-none transition",disabled:""},null,512),[[H,l.value]])])):q("",!0),r("div",Gt,[r("button",{onClick:t[3]||(t[3]=e=>y.value=!1),class:"bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-6 rounded-lg transition"}," Cancelar "),r("button",{onClick:nt,class:"bg-green-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-6 rounded-lg transition"}," Imprimir "),r("button",{onClick:at,class:"bg-approveGreen hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition"}," Generar Corte ")])])]),_:1},8,["show"])],64))}};export{$t as default};
