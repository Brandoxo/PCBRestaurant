import{z as ct,j as B,r as F,g as p,o as f,b as r,a as ut,k as A,i as q,q as H,F as C,s as N,t as c,n as dt,d as pt,x as I,w as ft,f as G,B as gt,C as R,S as mt,y as z}from"./app-BdgsrtZu.js";import{_ as ht}from"./Modal-DbXDnL_g.js";const vt={class:"bg-white p-4 rounded-2xl w-full max-w-96 sm:max-w-[40rem] lg:max-w-full mx-auto"},yt={class:"flex gap-4 justify-between mx-auto"},bt={class:"overflow-y-auto lg:py-60 lg:h-screen lg:pt-0 lg:pb-0 scrollbar-hide"},_t={class:"w-full mt-2 border"},St={class:"border p-2 text-center"},xt={class:"border p-2 text-center"},Ct={class:"border p-2 text-center"},wt={class:"border p-2 text-center"},Tt={class:"border p-2 text-center"},Ft={class:"border p-2 text-center"},Dt={class:"border p-2 text-center"},Mt={class:"border p-2 text-center"},Pt={class:"border p-1 text-center"},jt={class:"mt-4 flex justify-center"},kt=["onClick","innerHTML"],Bt=["innerHTML"],At={class:"p-8 bg-gradient-to-br from-white via-gray-50 to-gray-200 rounded-2xl shadow-2xl mx-auto"},Nt=["value"],Gt={key:0,class:"mb-4"},Ot={class:"flex justify-end gap-3 mt-8"},Et={__name:"ListSales",props:{sales:Object,cashFloat:Object,shifts:Object,roomServiceConfig:Object},setup(Q){const l=Q,_=ct().props.auth.user;console.log("User Permissions:",_.permissions),console.log("Room Service Config:",l.roomServiceConfig);const D=Number(l.cashFloat&&l.cashFloat.amount?l.cashFloat.amount:0),X=B(()=>_&&_.permissions&&_.permissions.includes("generate cutoff")),S=F(""),a=F(""),b=F(!1),g=F(""),Y=()=>{b.value=!0},M=()=>{b.value=!1},O=o=>new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(o),J=(o,t)=>`${o} x ${O(t)}`,K=(o,t)=>O(o*t),P=o=>{const t=l.shifts.find(e=>e.name_shift===o);return t?`${t.start_time} - ${t.end_time}`:""};console.log("Schedule for Matutino:",P("Matutino")),console.log("Schedule for Vespertino:",P("Vespertino"));function x(o=a.value,t=S.value){var m;if(!o||!t)return[];console.log("Filtering sales for shift:",o,"and date:",t);const e=P(o);if(!e)return console.warn("No schedule for shift:",o),[];const[s="",n=""]=e.split("-").map(u=>u.trim());console.log("Shift schedule:",s,n);const i=u=>{const d=(u||"0:00").split(":").map(Number);return{hours:Number.isFinite(d[0])?d[0]:0,minutes:Number.isFinite(d[1])?d[1]:0}};console.log("Parsed start time:",i(s)),console.log("Parsed end time:",i(n));const h=i(s),v=i(n),y=Array.isArray((m=l.sales)==null?void 0:m.data)?l.sales.data:[];return console.log("Total sales to filter:",y.length),y.filter(u=>{const d=new Date(u.date_time);if(isNaN(d))return!1;const L=d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");if(L!==t)return!1;console.log("Sale date matches selected date:",L);const T=d.getHours(),W=d.getMinutes(),j=T>h.hours||T===h.hours&&W>=h.minutes;console.log("isAfterStart:",j);const k=T<v.hours||T===v.hours&&W<=v.minutes;return console.log("isBeforeEnd:",k),console.log("Sales includes:",u.id,"->",j&&k),j&&k})}function Z(o){return!o||!o.length?null:new Date(Math.min(...o.map(t=>new Date(t.date_time))))}const tt=B(()=>l.roomServiceConfig&&l.roomServiceConfig.length>0&&l.roomServiceConfig[0].is_active),et=B(()=>tt.value&&l.roomServiceConfig.length>0&&l.roomServiceConfig[0].service_cost||0);function w(o){const t=(o||[]).filter(n=>!n.is_courtesy).reduce((n,i)=>n+i.quantity*i.unit_price,0),e=(o||[]).filter(n=>!n.is_courtesy&&n.is_room).reduce((n,i)=>n+i.quantity*i.unit_price*(et.value/100),0),s=t+e;return{baseTotal:t,serviceTotal:e,totalWithService:s}}function V(o){const t=new Set;let e=0;return o.forEach(s=>{s.order&&!t.has(s.order.id)&&s.order.tip!==null&&s.order.tip!==void 0&&s.order.tip!==""&&(e+=parseFloat(s.order.tip),t.add(s.order.id))}),e}function $(o){return o.reduce((t,e)=>{const s=e.order&&e.order.tip_percent?parseFloat(e.order.tip_percent):0;return t+e.quantity*e.unit_price*(s/100)},0)}function E(o){const t=new Date(o);return t.getFullYear()+"-"+String(t.getMonth()+1).padStart(2,"0")+"-"+String(t.getDate()).padStart(2,"0")+" "+String(t.getHours()).padStart(2,"0")+":"+String(t.getMinutes()).padStart(2,"0")+":"+String(t.getSeconds()).padStart(2,"0")}async function U(){const o=g.value;if(!o||!a.value)return alert("Por favor, selecciona una fecha y un turno."),null;const t=x(a.value,o);if(!t||!t.length)return null;const e=Z(t),s=w(t),n=s.baseTotal,i=s.serviceTotal,h=s.totalWithService,v=V(t),y=$(t);return{user_id:_.id,start_date:E(e),end_date:E(e),shift:a.value,initial_amount:D,total_amount:n,total_service:i,total_with_service:h,final_amount:D+h,total_tips:v+y}}function ot(o=a.value,t=g.value){let e=x(o,t);return e=e.filter(s=>s.payment_method==="Efectivo"&&!s.is_courtesy),e}function rt(o=a.value,t=g.value){let e=x(o,t);return e=e.filter(s=>s.payment_method==="Tarjeta"&&!s.is_courtesy),e}function st(o=a.value,t=g.value){let e=x(o,t);return e=e.filter(s=>s.is_courtesy===1),e}async function at(){const o=await U();try{const t=await R.post("/CashAudit",o);z().success("Corte de caja Generado Exitosamente"),M(),alert(`Corte de caja generado y guardado exitosamente.
Propinas: $${o.total_tips.toFixed(2)}`)}catch{M(),z().error("Error al generar el corte de caja")}}const nt=async()=>{if(!await U()){alert("No hay ventas para la fecha y turno seleccionados.");return}M(),mt.fire({title:"¿Estás seguro?",text:"¡No podrás revertir esto!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sí, generar corte",cancelButtonText:"Cancelar"}).then(t=>{t.isConfirmed&&at()})},lt=()=>{const o=g.value,t=x(a.value,o);if(!t.length){alert("No hay ventas para la fecha y turno seleccionados.");return}const e=w(t),s=e.totalWithService,n=w(ot(a.value,o)),i=w(rt(a.value,o)),v=(st(a.value,o)||[]).reduce((m,u)=>m+u.quantity*u.unit_price,0),y={fecha:g.value,turno:a.value,totalVentas:e.baseTotal,totalRoomService:e.serviceTotal,montoFinal:D+s,totalPropinas:V(t)+$(t),totalEfectivo:n.totalWithService,totalTarjeta:i.totalWithService,totalCortesias:v};console.clear(),console.log("Cut Off Data:",y.montoFinal),R.get(route("print.cutOff"),{params:{data:y}}).then(m=>{if(m.data&&m.data.printData){const u="print://"+m.data.printData;window.location.href=u}})};function it(){console.log("Selected date:",S.value),I.get(route("Sales/Index"),{date:S.value},{preserveState:!0,replace:!0})}return(o,t)=>(f(),p(C,null,[r("div",vt,[r("div",yt,[A(r("input",{"onUpdate:modelValue":t[0]||(t[0]=e=>S.value=e),onChange:it,type:"date",placeholder:"Buscar Ventas por fecha",class:"border p-2 rounded-lg w-full"},null,544),[[H,S.value]]),X.value?(f(),p("button",{key:0,onClick:Y,class:"bg-approveGreen hover:bg-green-700 text-white px-4 py-2 lg:w-96 rounded-md uppercase"}," Generar Corte de Caja ")):q("",!0)]),r("div",bt,[r("table",_t,[t[6]||(t[6]=r("thead",null,[r("tr",{class:"bg-gray-100"},[r("th",{class:"p-4"},"#"),r("th",{class:"p-4"},"Fecha de Creación"),r("th",{class:"p-4"},"Orden ID"),r("th",{class:"p-4"},"Usuario"),r("th",{class:"p-4"},"Producto"),r("th",{class:"p-4"},"Subtotal"),r("th",{class:"p-4"},"Total"),r("th",{class:"p-4"},"Método de Pago"),r("th",{class:"p-1"},"Room Service")])],-1)),r("tbody",null,[(f(!0),p(C,null,N(l.sales.data,e=>(f(),p("tr",{key:e.id},[r("td",St,c(e.id),1),r("td",xt,c(e.date_time),1),r("td",Ct,c(e.order_id),1),r("td",wt,c(e.user.name),1),r("td",Tt,c(e.product?e.product.name:e.product_id),1),r("td",Ft,c(J(e.quantity,e.unit_price)),1),r("td",Dt,c(K(e.quantity,e.unit_price)),1),r("td",Mt,c(e.payment_method),1),r("td",Pt,c(e.is_room?"Sí":"No"),1)]))),128))])])]),r("div",jt,[(f(!0),p(C,null,N(l.sales.links,e=>(f(),p(C,{key:e.label},[e.url?(f(),p("button",{key:0,onClick:s=>pt(I).get(e.url,{},{preserveState:!0,replace:!0}),class:dt(["px-3 py-1 mx-1 rounded",{"bg-approveGreen text-white":e.active}]),innerHTML:e.label},null,10,kt)):(f(),p("span",{key:1,class:"px-3 py-1 mx-1 text-gray-400",innerHTML:e.label},null,8,Bt))],64))),128))])]),ut(ht,{show:b.value,"onUpdate:show":t[4]||(t[4]=e=>b.value=e),onClose:t[5]||(t[5]=e=>b.value=!1)},{default:ft(()=>[r("div",At,[t[9]||(t[9]=r("h3",{class:"text-2xl font-extrabold text-gray-800 mb-2 flex items-center gap-2"},[r("svg",{class:"w-7 h-7 text-approveGreen",fill:"none",stroke:"currentColor","stroke-width":"2",viewBox:"0 0 24 24"},[r("path",{d:"M12 8v4l3 3"}),r("circle",{cx:"12",cy:"12",r:"10"})]),G(" Generar Corte ")],-1)),t[10]||(t[10]=r("p",{class:"mb-6 text-gray-600 text-base"},[G(" ¿Cuál será el "),r("span",{class:"font-semibold text-approveGreen"},"Turno"),G(" para este corte de caja? ")],-1)),A(r("select",{"onUpdate:modelValue":t[1]||(t[1]=e=>a.value=e),class:"border border-gray-300 rounded-lg p-3 w-full focus:ring-2 focus:ring-approveGreen focus:outline-none transition mb-4"},[t[7]||(t[7]=r("option",{value:"",disabled:""},"Seleccione un turno",-1)),(f(!0),p(C,null,N(l.shifts,e=>(f(),p("option",{key:e.id,value:e.name_shift},c(e.name_shift)+" "+c(e.start_time.slice(0,5))+" - "+c(e.end_time.slice(0,5)),9,Nt))),128))],512),[[gt,a.value]]),a.value==="Matutino"||a.value==="Vespertino"?(f(),p("div",Gt,[t[8]||(t[8]=r("label",{class:"block text-gray-700 font-medium mb-2"},"Selecciona la fecha",-1)),A(r("input",{"onUpdate:modelValue":t[2]||(t[2]=e=>g.value=e),type:"date",class:"border border-gray-300 rounded-lg p-3 w-full focus:ring-2 focus:ring-approveGreen focus:outline-none transition"},null,512),[[H,g.value]])])):q("",!0),r("div",Ot,[r("button",{onClick:t[3]||(t[3]=e=>b.value=!1),class:"bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-6 rounded-lg transition"}," Cancelar "),r("button",{onClick:lt,class:"bg-green-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-6 rounded-lg transition"}," Imprimir "),r("button",{onClick:nt,class:"bg-approveGreen hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition"}," Generar Corte ")])])]),_:1},8,["show"])],64))}};export{Et as default};
